# NOTE refs
# - https://github.blog/changelog/2020-04-15-github-actions-new-workflow-features/#new-fromjson-method-in-expressions
# - https://stackoverflow.com/questions/59977364/github-actions-how-use-strategy-matrix-with-script

name: sync
on:
  pull_request: {}
  push:
    branches:
      - main
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch: {}
permissions:
  contents: read
  id-token: write
  packages: write
  security-events: write
concurrency:
  group: ${{ github.run_id }}
  cancel-in-progress: false
jobs:
  sync:
    env:
      ECR: 862640294325.dkr.ecr.ap-southeast-2.amazonaws.com
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4.1.3
        if: github.ref_name == 'main'
      - name: dry run copy to ghcr.io
        env:
          GH_TOKEN: ${{ secrets.GH_CI_USER_TOKEN }}
        run: |
          echo -n ${GH_TOKEN} | podman login -u mountainmossbot --password-stdin ghcr.io --verbose
          podman secret create github-auth "/run/user/1001/containers/auth.json"
          podman run --volume "${PWD}:/src" --workdir /src --secret=github-auth ghcr.io/geonet/base-images/stable:v1.16 sync --authfile=/run/secrets/github-auth --dry-run --all --src yaml --dest docker sync-ghcr.yml ghcr.io/geonet/base-images
      - name: copy to ghcr.io
        run: |
          podman run --volume "${PWD}:/src" --workdir /src --secret=github-auth ghcr.io/geonet/base-images/stable:v1.16 sync --authfile=/run/secrets/github-auth --all --keep-going --src yaml --dest docker sync-ghcr.yml ghcr.io/geonet/base-images
        if: github.ref_name == 'main'
